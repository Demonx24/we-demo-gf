<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>èŠå¤©æµ‹è¯•</title>
    <style>
        body { font-family: sans-serif; padding: 10px; display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
        .panel { border: 1px solid #ddd; border-radius: 6px; padding: 10px; }
        #sessions li, #users li { cursor: pointer; padding: 6px; border-bottom: 1px dashed #eee; }
        #sessions li.active { background: #f6faff; }
        #msgs { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 6px; margin-top: 6px; white-space: pre-wrap; }
        .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        input { padding: 4px 6px; }
        button { padding: 6px 12px; }
        small.badge{padding:2px 6px;border-radius:10px;background:#eee;margin-left:6px;}
    </style>
</head>
<body>

<div class="panel">
    <h3>æˆ‘çš„è´¦å·</h3>
    <div class="row">
        <label>ç”¨æˆ·ID: <input id="userID" value="1"></label>
        <label>æ˜µç§°: <input id="nickname" value="æµ‹è¯•ç”¨æˆ·1"></label>
    </div>
    <div class="row">
        <button onclick="connectWS()">è¿æ¥ WebSocket</button>
        <button onclick="manualLoadSessions()">æ‰‹åŠ¨åˆ·æ–°ä¼šè¯</button>
        <button onclick="loadUsers()">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
    </div>

    <h3>ç”¨æˆ·åˆ—è¡¨</h3>
    <ul id="users"></ul>

    <h3>ä¼šè¯åˆ—è¡¨</h3>
    <ul id="sessions"></ul>
</div>

<div class="panel">
    <h3>å½“å‰ä¼šè¯</h3>
    <div class="row">
        <div>ä¼šè¯ID: <span id="curSid">-</span></div>
        <div>å¯¹ç«¯: <span id="peerId">-</span></div>
        <small class="badge" id="peerOnline">ç¦»çº¿</small>
    </div>

    <div id="msgs"></div>

    <div class="row" style="margin-top:10px;">
        <input id="content" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;">
        <button onclick="sendMessage()">å‘é€</button>
    </div>

    <h4>æ—¥å¿—</h4>
    <div id="log" style="height:120px;overflow:auto;border:1px solid #eee;padding:6px;"></div>
</div>

<script>
    let ws;
    const API = location.origin;

    let sessions = new Map();   // sid -> sessionå¯¹è±¡
    let currentSession = null;  // é€‰ä¸­çš„sessionå¯¹è±¡
    let messages = [];          // å½“å‰ä¼šè¯çš„æ¶ˆæ¯

    function log(msg) {
        const box = document.getElementById('log');
        const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
        box.innerText += line + "\n";
        box.scrollTop = box.scrollHeight;
    }

    // ===== ç”¨æˆ·åˆ—è¡¨ =====
    async function loadUsers() {
        const res = await fetch(API + "/user/list");
        const ret = await res.json();
        const ul = document.getElementById("users");
        ul.innerHTML = "";
        if (ret.code !== 0) {
            log("âŒ è·å–ç”¨æˆ·å¤±è´¥: " + ret.msg);
            return;
        }
        const myId = parseInt(document.getElementById("userID").value);
        ret.data.forEach(u => {
            if (u.user_id === myId) return; // ä¸å±•ç¤ºè‡ªå·±
            const li = document.createElement("li");
            li.textContent = `#${u.user_id} ${u.username} (${u.is_online === 1 ? "åœ¨çº¿" : "ç¦»çº¿"})`;
            li.onclick = () => createSessionWith(u.user_id);
            ul.appendChild(li);
        });
    }

    async function createSessionWith(peerId) {
        const myId = parseInt(document.getElementById("userID").value);
        const res = await fetch(API + "/talk/session/save", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ send_id: myId, receiver_id: peerId })
        });
        const ret = await res.json();
        if (ret.code === 0) {
            log(`âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ, SID=${ret.data.id}`);
            // è‡ªåŠ¨åŠ è½½ä¼šè¯å¹¶æ‰“å¼€
            await manualLoadSessions();
            openSession(ret.data.id, myId);
        } else {
            log("âŒ ä¼šè¯åˆ›å»ºå¤±è´¥: " + ret.msg);
        }
    }

    // ===== ä¼šè¯åˆ—è¡¨ & æ¶ˆæ¯ =====
    function renderSessions(list) {
        const ul = document.getElementById('sessions');
        ul.innerHTML = "";
        sessions.clear();
        const uid = parseInt(document.getElementById('userID').value);

        list.forEach(s => {
            sessions.set(s.id, s);
            const li = document.createElement('li');
            const online = s.is_online === 1 ? "âœ…" : "âŒ";
            const unread = s.un_read_num || 0;
            li.textContent = `#${s.id} [${s.name}] ${online} æœªè¯»:${unread}  æœ€å: ${s.msg_text || ""}`;
            if (currentSession && currentSession.id === s.id) li.classList.add('active');
            li.onclick = () => openSession(s.id, uid);
            ul.appendChild(li);
        });
    }

    function renderMessages(arr) {
        const box = document.getElementById('msgs');
        box.innerHTML = "";
        arr.forEach(m => {
            const who = m.send_id === parseInt(document.getElementById('userID').value) ? "æˆ‘" : `ç”¨æˆ·${m.send_id}`;
            const line = `${who}ï¼š${m.content}  (${m.created_at || m.CreatedAt || ""})`;
            const div = document.createElement('div');
            div.textContent = line;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    // ===== WebSocket ç›¸å…³ =====
    function connectWS() {
        const uid = document.getElementById('userID').value;
        const name = document.getElementById('nickname').value;
        ws = new WebSocket(`ws://${location.host}/ws?id=${uid}&name=${encodeURIComponent(name)}`);

        ws.onopen = () => log("âœ… WS å·²è¿æ¥");
        ws.onclose = () => log("âŒ WS å·²æ–­å¼€");
        ws.onmessage = (evt) => {
            const data = JSON.parse(evt.data);
            if (data.event === "connect") {
                log("ğŸ¤ " + JSON.stringify(data.content));
                return;
            }
            if (data.event === "pong") return;

            switch (data.action) {
                case "session_list":
                    renderSessions(data.data || []);
                    break;
                case "offline_messages":
                    log(`ğŸ“¦ æ”¶åˆ°ç¦»çº¿æ¶ˆæ¯ ${data.data.length} æ¡`);
                    (data.data || []).forEach(pushMessageToUI);
                    break;
                case "new_message":
                    pushMessageToUI(data.data);
                    manualLoadSessions(true);
                    break;
                case "session_updated":
                    const s = data.data;
                    if (s) {
                        sessions.set(s.id, s);
                        renderSessions(Array.from(sessions.values()));
                        if (currentSession && currentSession.id === s.id) updatePeerStatusUI(s);
                    }
                    break;
                case "user_presence":
                    log(`ğŸ‘¤ ç”¨æˆ·${data.data.user_id} ${data.data.online ? "ä¸Šçº¿" : "ç¦»çº¿"}`);
                    manualLoadSessions(true); // åŒæ­¥ä¼šè¯çŠ¶æ€
                    break;
                default:
                    log("æ”¶åˆ°: " + evt.data);
            }
        };
    }

    function pushMessageToUI(m) {
        if (!m) return;
        if (currentSession && m.session_id === currentSession.id) {
            messages.push(m);
            renderMessages(messages);
        }
    }

    async function manualLoadSessions(silent=false) {
        const uid = document.getElementById("userID").value;
        const res = await fetch(API + "/talk/session/list?user_id=" + uid);
        const ret = await res.json();
        if (ret.code === 0) {
            renderSessions(ret.data || []);
        } else if (!silent) {
            log("âŒ åŠ è½½ä¼šè¯å¤±è´¥: " + ret.msg);
        }
    }

    async function openSession(sid, myUid) {
        currentSession = sessions.get(sid);
        if (!currentSession) return;

        document.getElementById('curSid').innerText = sid;
        const peer = (myUid === currentSession.send_id) ? currentSession.receiver_id : currentSession.send_id;
        document.getElementById('peerId').innerText = peer;
        updatePeerStatusUI(currentSession);

        const res = await fetch(API + `/talk/message/list?sid=${sid}&page=1&size=50`);
        const ret = await res.json();
        if (ret.code === 0) {
            messages = ret.data.slice().reverse();
            renderMessages(messages);
        } else {
            log("âŒ åŠ è½½æ¶ˆæ¯å¤±è´¥: " + ret.msg);
        }

        await fetch(API + "/talk/session/read", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ session_id: sid, user_id: myUid })
        });

        const s = sessions.get(sid);
        if (s) { s.un_read_num = 0; sessions.set(sid, s); renderSessions(Array.from(sessions.values())); }
    }

    function updatePeerStatusUI(sess) {
        const tag = document.getElementById('peerOnline');
        tag.innerText = (sess.is_online === 1 ? "åœ¨çº¿" : "ç¦»çº¿");
    }

    async function sendMessage() {
        if (!currentSession) {
            log("âŒ è¯·å…ˆé€‰æ‹©ä¼šè¯");
            return;
        }
        const myUid = parseInt(document.getElementById("userID").value);
        const content = document.getElementById("content").value.trim();
        if (!content) return;

        if (myUid !== currentSession.send_id && myUid !== currentSession.receiver_id) {
            log("âŒ ä½ ä¸åœ¨è¯¥ä¼šè¯ä¸­");
            return;
        }
        const expectedReceiver = (myUid === currentSession.send_id) ? currentSession.receiver_id : currentSession.send_id;

        const payload = {
            session_id: currentSession.id,
            send_id: myUid,
            receiver_id: expectedReceiver,
            msg_type: 1,
            content: content,
            nickname: document.getElementById("nickname").value,
            avatar: "https://placekitten.com/50/50"
        };

        const res = await fetch(API + "/talk/message/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const ret = await res.json();
        if (ret.code === 0) {
            pushMessageToUI({ ...payload, session_id: currentSession.id, send_id: myUid, created_at: new Date().toISOString() });
            document.getElementById("content").value = "";
        } else {
            log("âŒ å‘é€å¤±è´¥: " + ret.msg);
        }
    }
</script>
</body>
</html>
